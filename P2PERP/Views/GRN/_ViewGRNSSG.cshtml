@{
    Layout = null;
}

<div class="card shadow p-4">
    <!-- Header info -->
    <div class="row mb-2">
        <div class="col-md-4">
            <label>PONO:</label>
            <input type="text" class="form-control form-control-sm bg-light" id="txtPONumberUnique" value="@ViewBag.POCode" readonly>
        </div>
        <div class="col-md-4">
            <label>PODATE:</label>
            <input type="date" class="form-control form-control-sm bg-light" id="txtPODateUnique" value="@ViewBag.PODate" readonly>
        </div>
        <div class="col-md-4">
            <label>VENDOR NAME:</label>
            <input type="text" class="form-control form-control-sm bg-light" id="txtVendorNameUnique" value="@ViewBag.VendorName" readonly>
        </div>
    </div>

    <!-- GRN / Invoice info -->
    <div class="row mb-2">
        <div class="col-md-4">
            <label>GRNNO:</label>
            <input type="text" class="form-control form-control-sm bg-light" id="txtGRNNumberUnique" value="@ViewBag.GRNCode" readonly>
        </div>
        <div class="col-md-4">
            <label>INVOICE NO:</label>
            <input type="text" class="form-control form-control-sm bg-light" id="txtInvoiceNumberUnique" value="@ViewBag.InvoiceNo" readonly>
        </div>
        <div class="col-md-4">
            <label>INVOICE DATE:</label>
            <input type="date" class="form-control form-control-sm bg-light" id="txtInvoiceDateUnique" value="@ViewBag.InvoiceDate" readonly>
        </div>
    </div>

    <!-- Addresses -->
    <div class="row mb-2">
        <div class="col-md-6">
            <label>COMPANY ADDRESS:</label>
            <textarea class="form-control form-control-sm bg-light" rows="2" id="txtCompanyAddressUnique" readonly>@ViewBag.CompanyAddress</textarea>
        </div>
        <div class="col-md-6">
            <label>BILLING ADDRESS:</label>
            <textarea class="form-control form-control-sm bg-light" rows="2" id="txtBillingAddressUnique" readonly>@ViewBag.BillingAddress</textarea>
        </div>
    </div>

    <h4 class="mt-3">Item Details</h4>

    <div class="table-responsive shadow p-2 bg-white rounded">
        <table class="table table-bordered table-sm text-center align-middle" id="tblGRNItemsUnique">
            <thead class="table-dark">
                <tr>
                    <th><input type="checkbox" id="chkSelectAllUnique" /></th>
                    <th>Sr. No.</th>
                    <th>Item Name</th>
                    <th>Quality Check</th>
                    <th>PO Qty</th>
                    <th>GRN Qty</th>
                    <th>Remaining Qty</th>
                    <th>Unit Rate</th>
                    <th>Discount %</th>
                    <th>GST %</th>
                    <th>Amount (₹)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="row mt-2">
        <div class="col-md-3 offset-md-9">
            <div class="p-2 rounded-3 text-center" style="background-color:#8a4fff; color:white; font-size:1rem; font-weight:500;">
                Total Amount : ₹<span id="txtTotalAmountUniqueDisplay">0.00</span>
            </div>
        </div>
    </div>


</div>

<script>
$(document).ready(function () {
    const GRNCode = '@ViewBag.GRNCode';
    toastr.options = { closeButton: true, progressBar: true, positionClass: "toast-top-right", timeOut: "3000" };

    const parseNum = val => !val ? 0 : parseFloat(String(val).replace(/[,₹\s%]+/g,'').replace(/[^0-9.\-]/g,'')) || 0;

    // Initialize DataTable
    const tableUnique = $('#tblGRNItemsUnique').DataTable({
        ajax: {
            url: '/GRN/GetGRNItemsSSG',
            type: 'GET',
            data: { GRNCode },
            dataSrc: json => (json && json.success && Array.isArray(json.items)) ? json.items : []
        },
        columns: [
            { data: "ItemCode", orderable: false, className: 'text-center', render: d => `<input type="checkbox" class="chkRowUnique" value="${d}" />` },
            { data: null, className: 'text-center', render: (d, t, r, m) => m.row + 1 },
            { data: "ItemName", className: 'text-center' },
            { data: "qc", className: 'text-center' },
            { data: "POQuantity", className: 'text-center' },
            { data: "GRNQuantity", className: 'text-center' },
            { data: "RemainingQuantity", className: 'text-center' },
            { data: "UnitRate", className: 'text-center', render: d => parseNum(d).toFixed(2) },
            { data: "Discount", className: 'text-center', render: d => parseNum(d).toFixed(2) + " %" },
            { data: "GST", className: 'text-center', render: d => parseNum(d).toFixed(2) + " %" },
            {
                data: null,
                className: 'text-center',
                render: d => {
                    const qty = parseNum(d.GRNQuantity),
                        rate = parseNum(d.UnitRate),
                        discount = parseNum(d.Discount),
                        gst = parseNum(d.GST),
                        base = qty * rate,
                        afterDiscount = base - (base * discount / 100),
                        total = afterDiscount + (afterDiscount * gst / 100);
                    return `₹ ${total.toFixed(2)}`;
                }
            }

        ],

        dom:'<"row mb-3"<"col-md-6 d-flex gap-2 align-items-center"B><"col-md-6 d-flex justify-content-end"f>>t<"row mt-3"<"col-md-6"i><"col-md-6 d-flex justify-content-end"p>>',
         buttons: [
            // --- PRINT ---
             {
                 extend: 'print',
                 text: '<i class="bi bi-printer-fill fs-5"></i>',
                 title: 'GRN Items List',
                 exportOptions: {
                     columns: [2, 3, 4, 5, 6, 7, 8, 9, 10],
                     rows: (idx, data, node) => $(node).find('.chkRowUnique').is(':checked')
                 },
                 customize: function (win) {
                     let sn = 0;
                     let theadRow = $(win.document.body).find('table thead tr');
                     theadRow.prepend('<th style="background-color: #000; color: #fff;">S.No.</th>');
                     $(win.document.body).find('table tbody tr').each(function () {
                         $(this).prepend('<td>' + (++sn) + '</td>');
                     });

                     $(win.document.body).find('table thead th').css({
                         'background-color': '#000',
                         'color': '#fff',
                         'padding': '6px',
                         'text-align': 'left'
                     });
                     $(win.document.body).find('table').css({
                         'border-collapse': 'collapse',
                         'width': '100%',
                         'font-size': '12px'
                     });
                     $(win.document.body).find('table th, table td').css({
                         'border': '1px solid #000',
                         'padding': '4px'
                     });
                 },
                 action: function (e, dt, btn, config) {
                     if ($('#tblGRNItemsUnique tbody .chkRowUnique:checked').length === 0) {
                         toastr.warning("Select at least one row before printing!");
                         return;
                     }
                     $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, btn, config);
                 }
             },


            //pdf
            {
                extend: 'pdfHtml5',
                text: '<i class="bi bi-file-earmark-pdf fs-5 text-danger"></i>',
                title: '',
                filename: `GRN Items List - ${moment().format("DD-MM-YYYY")}`,
                exportOptions: {
                    columns: [2, 3, 4, 5, 6, 7, 8, 9, 10],
                    rows: (idx, data, node) => $(node).find('.chkRowUnique').is(':checked')
                },
                customize: function (doc) {
                    let sn = 0;

                    doc.content.unshift({
                        text: 'GRN Items List',
                        fontSize: 16,
                        bold: true,
                        alignment: 'center',
                        margin: [0, 0, 0, 5]
                    });

                    doc.content.splice(1, 0, {
                        text: `Generated Date: ${moment().format("DD/MM/YYYY")}`,
                        fontSize: 11,
                        italics: true,
                        alignment: 'center',
                        margin: [0, 0, 0, 10]
                    });

                    let table = doc.content[doc.content.length - 1].table;

                    table.body[0].unshift({ text: 'S.No.' });

                    table.body[0].forEach(cell => {
                        cell.fillColor = '#343a40';
                        cell.color = '#fff';
                        cell.bold = true;
                        cell.alignment = 'center';
                    });

                    table.body.forEach((row, idx) => {
                        if (idx === 0) return;
                        row.unshift({ text: (++sn).toString(), alignment: 'center' });
                        for (let i = 1; i < row.length; i++) {
                            row[i].alignment = 'center';
                        }
                    });

                    table.layout = {
                        hLineWidth: () => 1,
                        vLineWidth: () => 1,
                        hLineColor: () => '#000',
                        vLineColor: () => '#000',
                        paddingLeft: () => 3,
                        paddingRight: () => 3,
                        paddingTop: () => 2,
                        paddingBottom: () => 2
                    };
                },
                action: function (e, dt, btn, config) {
                    if ($('#tblGRNItemsUnique tbody .chkRowUnique:checked').length === 0) {
                        toastr.warning("Select at least one row before exporting PDF!");
                        return;
                    }
                    $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, btn, config);
                }
            },


            //excel
            {
                extend: 'excelHtml5',
                text: '<i class="bi bi-file-earmark-excel fs-5 text-success"></i>',
                title: `GRN Items List - ${moment().format("YYYY-MM-DD")}`,
                exportOptions: {
                    columns: [2, 3, 4, 5, 6, 7, 8, 9, 10],
                    rows: (idx, data, node) => $(node).find('.chkRowUnique').is(':checked')
                },
                customize: function (xlsx) {
                    var sheet = xlsx.xl.worksheets['sheet1.xml'];
                    var rows = $('row', sheet);
                    let sn = 0;
                    var header = rows.eq(1);
                    header.prepend(
                        '<c r="A2" t="inlineStr"><is><t>S.No.</t></is></c>'
                    );
                    rows.each(function (i) {
                        if (i <= 1) return;
                        var rowNum = $(this).attr('r');
                        $(this).prepend(
                            '<c r="A' + rowNum + '" t="n"><v>' + (++sn) + '</v></c>'
                        );
                    });
                    rows.each(function () {
                        var rowNum = $(this).attr('r');
                        var colCode = 65;
                        $('c', this).each(function () {
                            $(this).attr('r', String.fromCharCode(colCode) + rowNum);
                            colCode++;
                        });
                    });
                },
                action: function (e, dt, btn, config) {
                    if ($('#tblGRNItemsUnique tbody .chkRowUnique:checked').length === 0) {
                        toastr.warning("Select at least one row before exporting Excel!");
                        return;
                    }
                    $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, btn, config);
                }
            },


            // --- CSV ---
            {
                extend: 'csvHtml5',
                text: '<i class="bi bi-filetype-csv text-success fs-5"></i>',
                title: `GRN_Items_List_${moment().format("YYYY-MM-DD")}`,
                bom: true,
                exportOptions: {
                    columns: [2, 3, 4, 5, 6, 7, 8, 9, 10],
                    rows: (idx, data, node) => $(node).find('.chkRowUnique').is(':checked')
                },
                customize: function (csv) {
                    let lines = csv.split('\n');
                    if (lines.length > 0) {
                        lines[0] = 'S.No.,' + lines[0];
                    }
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim() !== '') {
                            lines[i] = i + ',' + lines[i];
                        }
                    }
                    return lines.join('\n');
                },
                action: function (e, dt, btn, config) {
                    if ($('#tblGRNItemsUnique tbody .chkRowUnique:checked').length === 0) {
                        toastr.warning("Select at least one row before exporting CSV!");
                        return;
                    }
                    $.fn.dataTable.ext.buttons.csvHtml5.action.call(this, e, dt, btn, config);
                }
            }
        ],

        order:[[1,'asc']], paging:true, searching:true, info:false, lengthChange:false, responsive:true
    });

    function updateTotalAmountUnique() {
        let total = 0;

        tableUnique.rows().every(function () {
            const row = this.data();
            const qty = parseNum(row.GRNQuantity);
            const rate = parseNum(row.UnitRate);
            const discount = parseNum(row.Discount);
            const gst = parseNum(row.GST);

            const base = qty * rate;
            const afterDiscount = base - (base * discount / 100);
            total += afterDiscount + (afterDiscount * gst / 100);
        });

        // Update span with formatted value
        $('#txtTotalAmountUniqueDisplay').text(total.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
    }


    // Also call after every draw (e.g., pagination)
    tableUnique.on('draw', updateTotalAmountUnique);
    $(document).on('change', '#chkSelectAllUnique', function () {
        const checked = $(this).is(':checked');
        $('#tblGRNItemsUnique tbody .chkRowUnique').prop('checked', checked);
    });
    $(document).on('change', '.chkRowUnique', function () {
        const allChecked = $('#tblGRNItemsUnique tbody .chkRowUnique').length ===
            $('#tblGRNItemsUnique tbody .chkRowUnique:checked').length;
        $('#chkSelectAllUnique').prop('checked', allChecked);
    });

});
</script>
