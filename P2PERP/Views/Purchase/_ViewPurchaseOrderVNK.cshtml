@{

    var poCode = ViewBag.POCode?.ToString() ?? "";
}

<html>
<head>

    <style>
        #poItemsTable tbody td {
            font-size: 14px;
        }

        #poItemsTable tfoot th,
        #poItemsTable tfoot td {
            padding: 2px 8px;
            font-size: 13px;
            line-height: 1.2;
        }

        #termsCondition ul {
            list-style: none;
            padding-left: 0;
            margin-bottom: 0;
        }

        #termsCondition li {
            padding: 2px 0;
        }
    </style>
</head>

<body>

    <input type="hidden" id="PONCode" value="@poCode" />

    <!-- Single Card for all PO details -->
    <div class="card shadow-sm rounded-3">
        <div class=" d-flex justify-content-between align-items-center">
            <button class="btn btn-outline-primary btn-sm" id="btnPrint" title="Print">
                <i class="bi bi-printer-fill text-dark fs-5"></i>
            </button>
        </div>

        <div class="card-body">
            <!-- PO & Vendor Info -->
            <div class="row mb-3">
                <!-- Left -->
                <div class="col-md-6">
                    <h6 class="fw-bold mb-3">Invoice To</h6>
                    <div class="mb-2">
                        <label class="form-label">PO No</label>
                        <input id="po_no" class="form-control form-control-sm" readonly />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">PO Date</label>
                        <input id="po_date" class="form-control form-control-sm" readonly />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Company Name</label>
                        <input id="companyName" class="form-control form-control-sm" readonly />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Delivery Address</label>
                        <textarea id="deliveryAddress" class="form-control form-control-sm" rows="3" readonly></textarea>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Terms & Conditions</label>
                        <div id="termsCondition" class="small text-muted border rounded p-2 bg-light"></div>
                    </div>
                </div>

                <!-- Right -->
                <div class="col-md-6">
                    <h6 class="fw-bold mb-3">Vendor Details</h6>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label col-form-label-sm">Vendor Name</label>
                        <div class="col-sm-8">
                            <input id="vendorName" class="form-control form-control-sm" readonly />
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label col-form-label-sm">Vendor Company</label>
                        <div class="col-sm-8">
                            <input id="vendorCompany" class="form-control form-control-sm" readonly />
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label col-form-label-sm">Vendor Contact</label>
                        <div class="col-sm-8">
                            <input id="vendorContact" class="form-control form-control-sm" readonly />
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Vendor Address</label>
                        <textarea id="vendorAddress" class="form-control form-control-sm" rows="3" readonly></textarea>
                    </div>
                </div>
            </div>

            <!-- Item Details Table -->
            <div class="table-responsive">
                <table id="poItemsTable" class="table table-bordered table-sm align-middle m-0" style="width:100%">
                    <thead class="table-dark">
                        <tr class="text-center">
                            <th>SR NO</th>
                            <th>ITEM CODE</th>
                            <th>ITEM NAME</th>
                            <th>ITEM DESCRIPTION</th>
                            <th>QTY</th>
                            <th>UOM</th>
                            <th>UNIT RATE</th>
                            <th>DISCOUNT</th>
                            <th>GST</th>
                            <th class="text-end">AMOUNT</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="9" class="text-end">Subtotal</th>
                            <th id="ftSubtotal" class="text-end">₹0.00</th>
                        </tr>
                        <tr>
                            <th colspan="9" class="text-end">Transportation / Shipping</th>
                            <th id="ftShipping" class="text-end">₹0.00</th>
                        </tr>
                        <tr>
                            <th colspan="9" class="text-end">Grand Total</th>
                            <th id="ftGrandTotal" class="text-end">₹0.00</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>



    <script>
        $(function () {
            const POCode = $("#PONCode").val();

            function round2(n) { return Number((n || 0).toFixed(2)); }
            function calcLine(qty, unit, discPct, gstPct) {
                qty = Number(qty || 0); unit = Number(unit || 0); discPct = Number(discPct || 0); gstPct = Number(gstPct || 0);
                const base = qty * unit;
                const discAmt = base * (discPct / 100);
                const taxable = base - discAmt;
                const gstAmt = taxable * (gstPct / 100);
                const lineTotal = taxable + gstAmt;
                return { lineTotal: round2(lineTotal) };
            }

            // Load PO Header
            $.get('/Purchase/GetPOHeaderByCodeVNK', { POCode: POCode }, function (h) {
                if (!h) return;
                $("#po_no").val(h.POCode || '');
                $("#po_date").val(h.AddedDateVK || '');
                $("#companyName").val(h.InvoiceToCompanyName || '');
                $("#deliveryAddress").val(h.DeliveryAddress || '');
                if (h.TermConditionName) {
                    // Split terms by comma and clean up spaces
                    const termsArray = h.TermConditionName.split(',').map(t => t.trim()).filter(t => t);

                    // Create an unordered list with serial numbers
                    let ulHtml = '<ul class="mb-0 ps-3">';
                    termsArray.forEach((term, i) => {
                        ulHtml += `<li><strong>${i + 1}.</strong> ${term}</li>`;
                    });
                    ulHtml += '</ul>';

                    $("#termsCondition").html(ulHtml);
                } else {
                    $("#termsCondition").html('<em>No terms and conditions available</em>');
                }
                $("#vendorName").val(h.VendorName || '');
                $("#vendorCompany").val(h.VendorCompanyName || '');
                $("#vendorContact").val(h.VendorContact || '');
                $("#vendorAddress").val(h.VendorAddress || '');
            });

            // Load PO Items
            $.get('/Purchase/GetPOItemsByCodeVNK', { POCode: POCode }, function (rows) {
                           
                const $tb = $("#poItemsTable tbody").empty();
                if (!rows || rows.length === 0) {
                    $tb.append('<tr><td colspan="10" class="text-center text-muted">No items found</td></tr>');
                    return;
                }

                let subtotal = 0;
                rows.forEach(function (r, idx) {
                    const shipping = Number(r.ShippingCharges || 0);

                    $("#ftShipping").text("₹" + shipping.toFixed(2));

                    console.log(shipping)
                    console.log("rowdata",r)
                    const c = calcLine(r.Quantity, r.CostPerUnit, r.Discount, r.GSTPct);
                    subtotal += c.lineTotal;
                    $tb.append(`
                                    <tr>
                                        <td class="text-center">${idx + 1}</td>
                                        <td>${r.ItemCode || ''}</td>
                                        <td>${r.ItemName || ''}</td>
                                        <td title="${r.Description || ''}">${r.Description || ''}</td>
                                        <td class="text-end">${Number(r.Quantity || 0)}</td>
                                        <td>${r.UOMName || ''}</td>
                                        <td class="text-end">₹${Number(r.CostPerUnit || 0).toFixed(2)}</td>
                                        <td class="text-end">${Number(r.Discount || 0).toFixed(2)}%</td>
                                        <td class="text-end">${Number(r.GSTPct || 0).toFixed(2)}%</td>
                                        <td class="text-end">₹${c.lineTotal.toFixed(2)}</td>

                                    </tr>
                                `);
                });

                $("#ftSubtotal").text("₹" + subtotal.toFixed(2));
                const shippingcharges = Number($("#ftShipping").text().replace("₹", "").trim()) || 0;
                $("#ftGrandTotal").text("₹" + (subtotal + shippingcharges).toFixed(2));

                if ($.fn.DataTable.isDataTable('#poItemsTable')) {
                    $('#poItemsTable').DataTable().clear().destroy();
                }

                $('#poItemsTable').DataTable({
                    paging: true,
                    pageLength: 10,
                    ordering: false,
                    searching: false,
                    responsive: true,
                    lengthChange: false,
                    info: true
                });
            });

           

            // Print
            $("#btnPrint").on("click", function () {
                window.print();
            });
        });
    </script>
</body>
</html>