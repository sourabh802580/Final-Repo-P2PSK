@{
    ViewBag.Title = "Approved PR Items";
    string prCode = ViewBag.PRCode ?? "";
}

<div class="container mt-3">
    <!-- 🔹 PR Code Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="badge bg-secondary text-dark fs-6 px-3 py-2 shadow-sm">
            PR Code: @prCode
        </span>
    </div>

    <!-- PR Items Table -->
    <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="approvedPrItemsTable" class="table table-striped table-hover table-bordered align-middle mb-0">
                    <thead class="table-dark text-center">
                        <tr>
                            <th>Sr No</th>
                            <th>Item Name</th>
                            <th>Required Quantity</th>
                            <th>Unit Rate</th>
                            <th>Expected Date</th>
                        </tr>
                    </thead>
                    <tbody id="prItemBody" class="text-center">
                        <tr>
                            <td colspan="5" class="text-muted py-3">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Styles -->
<style>
    #approvedPrItemsTable thead th,
    #approvedPrItemsTable tbody td {
        text-align: center !important;
        vertical-align: middle !important;
    }

    .badge {
        font-size: 1rem;
    }
</style>

<!-- ✅ Script -->
<script>
    $(document).ready(function () {
        let prCode = '@prCode';

        // 🔹 Toast wrapper
        function showToast(message, type = "info") {
            toastr.options = {
                "closeButton": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "timeOut": "3000"
            };
            switch (type) {
                case "success": toastr.success(message); break;
                case "warning": toastr.warning(message); break;
                case "danger": toastr.error(message); break;
                default: toastr.info(message); break;
            }
        }

        // 🔹 Load PR Items
        $.ajax({
            url: '/Purchase/ShowApprovePRItemPRK',
            type: 'GET',
            data: { prCode: prCode },
            success: function (data) {
                let $tbody = $("#prItemBody");
                $tbody.empty();

                if (data && data.length > 0) {
                    let srNo = 1;
                    data.forEach(function (item) {
                        let formattedDate = "";

                        if (item.RequiredDateString) {
                            // Split the date string manually and rebuild with slashes
                            // Works for backend sending "YYYY-MM-DD"
                            let parts = item.RequiredDateString.split('-');
                            if (parts.length === 3) {
                                formattedDate = parts[0] + '/' + parts[1] + '/' + parts[2]; // DD/MM/YYYY
                            } else {
                                formattedDate = item.RequiredDateString; // fallback
                            }
                        }

                        $tbody.append(`
                                        <tr>
                                            <td>${srNo++}</td>
                                            <td>${item.ItemName}</td>
                                            <td>${item.RequiredQuantity}</td>
                                            <td>₹ ${item.UnitRates}</td>
                                            <td>${formattedDate}</td>
                                        </tr>
                                    `);
                         });



                    // ✅ DataTable with re-index
                    let table = $('#approvedPrItemsTable').DataTable({
                        paging: true,
                        searching: true,
                        ordering: true,
                        responsive: true,
                        lengthChange: false, // 🔹 Enable "entries per page"
                        info: true,          // 🔹 Show table info (e.g., "Showing 1 to 10 of 50 entries")
                        pageLength: 10,      // 🔹 Default entries per page
                        dom: '<"row mb-2"<"col-sm-6"l><"col-sm-6 text-end"f>>' + // top: left = entries, right = search
                            'rt' +
                            '<"row mt-2"<"col-sm-6"i><"col-sm-6 text-end"p>>',   // bottom: left = info, right = pagination

                        columnDefs: [
                            { className: "text-center", targets: "_all" },
                            { orderable: false, targets: 0 } // Sr No not sortable
                        ]
                    });


                    table.on('order.dt search.dt draw.dt', function () {
                        let i = 1;
                        table.cells(null, 0, { search: 'applied', order: 'applied' })
                             .every(function () { this.data(i++); });
                    }).draw();

                } else {
                    $tbody.html('<tr><td colspan="5" class="text-center text-muted py-3">No records found</td></tr>');
                    showToast("⚠ No items found for this PR", "warning");
                }
            },
            error: function () {
                $("#prItemBody").html('<tr><td colspan="5" class="text-center text-danger py-3">Error loading items</td></tr>');
                showToast("❌ Error loading PR items", "danger");
            }
        });
    });
</script>
