@{
    Layout = null;
    ViewBag.Title = "";
    var poCode = (string)ViewBag.POCode ?? "";
}

<html>
<head>
</head>


<body class="bg-light py-3">

    <input type="hidden" id="poCode" value="@ViewBag.POCode" />

    <div class="card shadow mx-auto p-4" style="max-width: 1100px;">

        <!-- Header -->
        <div class="mb-4">
            <div class="row g-3">
                <!-- Invoice To -->
                <div class="col-md-6">
                    <h6 class="fw-bold text-primary mb-2">Invoice To</h6>

                    <div class="mb-2">
                        <label class="form-label small">PO No</label>
                        <input id="po_no" class="form-control form-control-sm bg-secondary-subtle" readonly />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">PO Date</label>
                        <input id="po_date" class="form-control form-control-sm bg-secondary-subtle" readonly />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Company Name</label>
                        <input id="companyName" class="form-control form-control-sm bg-secondary-subtle" readonly />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Delivery Address</label>
                        <textarea id="deliveryAddress" class="form-control form-control-sm bg-secondary-subtle" rows="3" readonly></textarea>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Terms & Conditions</label>
                        <div id="termsCondition" class="small text-muted border rounded p-2 bg-secondary-subtle"></div>
                    </div>
                </div>

                <!-- Vendor Details -->
                <div class="col-md-6">
                    <h6 class="fw-bold text-primary mb-2">Vendor Details</h6>
                    <div class="mb-2">
                        <label class="form-label small">Vendor Name</label>
                        <input id="vendorName" class="form-control form-control-sm bg-secondary-subtle" readonly />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Vendor Company</label>
                        <input id="vendorCompany" class="form-control form-control-sm bg-secondary-subtle" readonly />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Vendor Contact</label>
                        <input id="vendorContact" class="form-control form-control-sm bg-secondary-subtle" readonly />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Vendor Address</label>
                        <textarea id="vendorAddress" class="form-control form-control-sm bg-secondary-subtle" rows="3" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item Details Table -->
        <div class="table-responsive">
            <table id="poItemsTable" class="table table-bordered align-middle text-center mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>SR NO</th>
                        <th>ITEM NAME</th>
                        <th>ITEM DESCRIPTION</th>
                        <th>QTY</th>
                        <th>UOM</th>
                        <th>UNIT RATE</th>
                        <th>DISCOUNT %</th>
                        <th>GST %</th>
                        <th>AMOUNT</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot class="fw-bold">
                    <tr>
                        <td colspan="8" class="text-end">Subtotal</td>
                        <td id="ftSubtotal" class="text-end">₹0.00</td>
                    </tr>
                    <tr>
                        <td colspan="8" class="text-end">Transportation / Shipping</td>
                        <td id="ftShipping" class="text-end">₹0.00</td>
                    </tr>
                    <tr style="background-color:#f5f5f5">
                        <td colspan="8" class="text-end">Grand Total</td>
                        <td id="ftGrandTotal" class="text-end">₹0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Action Buttons -->
        <div class="mt-4 text-center">
            <button id="btnApprove" class="btn btn-lg btn-success me-2">
                <i class="bi bi-check2-circle me-1"></i> Approve
            </button>
            <button id="btnReject" class="btn btn-lg btn-danger me-2">
                <i class="bi bi-x-circle me-1"></i> Reject
            </button>
            <button id="btnSendApproval" class="btn btn-lg btn-warning" disabled>
                <i class="bi bi-send me-1"></i> Send for Approval
            </button>
        </div>
    </div>
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary justify-content-center">
                    <h5 class="modal-title text-white text-center w-100">Reject Purchase Order</h5>
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 me-2 mt-2" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2 text-center fw-bold">PO Code: <span id="rejectPoCode">@poCode</span></div>
                    <label for="rejectReason" class="form-label">Reason for rejection</label>
                    <textarea id="rejectReason" class="form-control" rows="4" placeholder="Enter reason..."></textarea>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" id="confirmReject" class="btn btn-danger">Reject</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        $(function () {
            const poCode = $("#poCode").val();

            function round2(n) { return Number((n || 0).toFixed(2)); }
            function calcLine(qty, unit, discPct, gstPct) {
                qty = Number(qty || 0); unit = Number(unit || 0); discPct = Number(discPct || 0); gstPct = Number(gstPct || 0);
                const base = qty * unit;
                const discAmt = base * (discPct / 100);
                const taxable = base - discAmt;
                const gstAmt = taxable * (gstPct / 100);
                const lineTotal = taxable + gstAmt;
                return { lineTotal: round2(lineTotal) };
            }

            // Load Header
            $.getJSON('/Purchase/GetPOHeaderNAM', { poCode }, function (h) {
                if (!h) {
                    Swal.fire('Error', 'Header not found', 'error');
                    return;
                }
                $("#po_no").val(h.POCode || '');
                $("#po_date").val(h.AddedDateVK || '');
                $("#companyName").val(h.InvoiceToCompanyName || '');
                $("#deliveryAddress").val(h.DeliveryAddress || '');
                if (h.TermConditionName) {
                    // Split terms by comma and clean up spaces
                    const termsArray = h.TermConditionName.split(',').map(t => t.trim()).filter(t => t);

                    // Create an unordered list with serial numbers
                    let ulHtml = '<ul class="mb-0 ps-3">';
                    termsArray.forEach((term, i) => {
                        ulHtml += `<li><strong>${i + 1}.</strong> ${term}</li>`;
                    });
                    ulHtml += '</ul>';

                    $("#termsCondition").html(ulHtml);
                } else {
                    $("#termsCondition").html('<em>No terms and conditions available</em>');
                }
                $("#vendorName").val(h.VendorName || '');
                $("#vendorCompany").val(h.VendorCompanyName || '');
                $("#vendorContact").val(h.VendorContact || '');
                $("#vendorAddress").val(h.VendorAddress || '');
            });

            // Load Items
            $.getJSON('/Purchase/GetPOItemsNAM', { poCode }, function (rows) {
                const $tb = $("#poItemsTable tbody").empty();
                if (!rows || rows.length === 0) {
                    $tb.append('<tr><td colspan="9" class="text-center text-muted">No items</td></tr>');
                    return;
                }
                let subtotal = 0;
                rows.forEach((r, idx) => {
                    const c = calcLine(r.Quantity, r.CostPerUnit, r.Discount, r.GSTPct);
                    subtotal += c.lineTotal;
                    $tb.append(`
                                            <tr>
                                                <td>${idx + 1}</td>
                                                <td>${r.ItemName || ''}</td>
                                                <td>${r.Description || ''}</td>
                                                <td>${r.Quantity}</td>
                                                <td>${r.UOMName}</td>
                                                <td>₹${r.CostPerUnit.toFixed(2)}</td>
                                                <td>${r.Discount.toFixed(2)}%</td>
                                                <td>${r.GSTPct.toFixed(2)}%</td>
                                                <td class="text-end">₹${c.lineTotal.toFixed(2)}</td>
                                            </tr>`);
                });

                $("#ftSubtotal").text(`₹${subtotal.toFixed(2)}`);
                const shipping = Number($("#ftShipping").text().replace('₹', '') || 0);
                const grandTotal = subtotal + shipping;
                $("#ftGrandTotal").text(`₹${grandTotal.toFixed(2)}`);

                if (grandTotal > 500000) {
                    $("#btnApprove").prop("disabled", true);
                    $("#btnSendApproval").prop("disabled", false);
                } else {
                    $("#btnApprove").prop("disabled", false);
                    $("#btnSendApproval").prop("disabled", true);
                }

                // Initialize DataTable
                $("#poItemsTable").DataTable({
                    paging: false,
                    searching: true,
                    ordering: false,
                    info: false,
                    responsive: true,
                    columnDefs: [{ className: "text-center", targets: "_all" }]
                });
            });

            // Approve PO on this page
            $("#btnApprove").click(function () {
                const poCode = $("#poCode").val(); // get current PO code

                Swal.fire({
                    title: 'Are you sure?',
                    text: `Do you want to approve PO ${poCode}?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, approve it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.get('/Purchase/ApprovePONAM', { poCode }, function (res) {
                            if (res.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: `PO ${poCode} approved successfully`,
                                    showConfirmButton: false,
                                    timer: 2000
                                }).then(() => {
                                    // Redirect or refresh
                                    window.location.href = '/Purchase/PurchaseOrdersVNK';
                                });
                            } else {
                                Swal.fire('Error!', res.message || 'Failed to approve PO.', 'error');
                            }
                        });
                    }
                });
            });


            // Reject PO
            $("#btnReject").click(function () {
                $("#rejectReason").val('');
                $("#rejectPoCode").text($("#poCode").val()); // Set PO code inside modal form
                $("#rejectModal").modal('show');
            });

            $("#confirmReject").click(function () {
                const reason = $("#rejectReason").val().trim();
                if (reason === '') {
                    Swal.fire('Validation', 'Please enter rejection reason', 'warning');
                    return;
                }
                $.post('/Purchase/RejectPONAM', { poCode, reason }, function (res) {
                    if (res.success) {
                        Swal.fire({
                            icon: 'success',
                            title: `PO ${poCode} rejected!`,
                            text: `Reason: ${reason}`,
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            $("#rejectModal").modal('hide');
                            window.location.href = '/Purchase/PurchaseOrdersVNK';
                        });
                    } else {
                        Swal.fire('Error', res.message || 'Failed to reject PO.', 'error');
                    }
                });
            });

            // Send for Approval
            $("#btnSendApproval").click(function () {
                Swal.fire({
                    title: `Send PO ${poCode} for higher approval?`,
                    text: "Are you sure you want to send this PO for higher approval?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, send it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.post('/Purchase/SendForApprovalNAM', { poCode }, function (res) {
                            if (res.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: `PO ${poCode} sent for approval!`,
                                    showConfirmButton: false,
                                    timer: 1500
                                }).then(() => window.location.href = '/Purchase/PurchaseOrdersVNK');
                            } else {
                                Swal.fire('Error', res.message || 'Failed to send PO for approval.', 'error');
                            }
                        });
                    }
                });
            });
        });
    </script>


</body>
</html>