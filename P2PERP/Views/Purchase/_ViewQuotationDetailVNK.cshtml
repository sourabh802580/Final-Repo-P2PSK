@{
    var rqCode = (string)ViewBag.RegisterQuotationCode ?? "";
}

<html>
<head>
    <style>
        #grid thead th {
            text-align: center !important;
            vertical-align: middle;
            font-weight: 600;
        }

        #grid tbody td {
            font-size: 14px;
            vertical-align: middle;
        }

        #grid tfoot th, #grid tfoot td {
            font-weight: 600;
            font-size: 14px;
            padding: 4px 6px;
            line-height: 1.2;
            text-align: right;
        }

        #grid td.text-end {
            white-space: nowrap;
        }

        .table-hover tbody tr:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>

    <input type="hidden" id="rqCode" value="@rqCode" />

    <div class="container mt-4">
        <!-- Single Card wrapping everything -->
        <div class="card shadow-sm rounded bg-white p-4">

            <!-- Header with Print -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button class="btn btn-outline-primary btn-sm" id="btnPrint" title="Print">
                    <i class="bi bi-printer-fill text-dark fs-5"></i>
                </button>
            </div>

            <!-- Header Details -->
            <div class="row g-3 mb-4">
                <div class="col-md-2">
                    <label class="form-label">RFQ No</label>
                    <input id="RFQCode" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Register Quotation Code</label>
                    <input id="RegisterQuotationCode" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label class="form-label">VQ Date</label>
                    <input id="SystemDate" class="form-control" readonly />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Vendor Name</label>
                    <input id="VendorName" class="form-control" readonly />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Vendor Code</label>
                    <input id="VendorCode" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Vendor Company</label>
                    <input id="CompanyName" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Vendor Expected Delivery Date</label>
                    <input id="VendorDeliveryDate" class="form-control" readonly />
                </div>
            </div>

            <!-- Items Table -->
            <div class="table-responsive">
                <table class="table table-bordered table-hover m-0" id="grid">
                    <thead class="table-dark text-center">
                        <tr>
                            <th>SRNO</th>
                            <th>ITEM CODE</th>
                            <th>ITEM NAME</th>
                            <th>DESCRIPTION</th>
                            <th>QTY</th>
                            <th>UOM</th>
                            <th>COST/UNIT</th>
                            <th>Discount</th>
                            <th>GST</th>
                            <th>AMOUNT</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot class="text-end">
                        <tr>
                            <th colspan="9" class="text-end">SubTotal</th>
                            <th id="ftSubTotal">₹ 0.00</th>
                        </tr>
                        <tr>
                            <th colspan="9" class="text-end">Shipping Charges</th>
                            <th id="ftShipping">₹ 0.00</th>
                        </tr>
                        <tr>
                            <th colspan="9" class="text-end">GrandTotal</th>
                            <th id="ftGrand">₹ 0.00</th>
                        </tr>
                    </tfoot>
                </table>
            </div>

        </div>
    </div>



    <script>
        (function () {
            const rqCode = $("#rqCode").val();

            function calcLine(qty, cpu, discPct, gstPct) {
                qty = Number(qty || 0); cpu = Number(cpu || 0); discPct = Number(discPct || 0); gstPct = Number(gstPct || 0);
                const base = qty * cpu;
                const discAmt = base * (discPct / 100);
                const taxable = base - discAmt;
                const gstAmt = taxable * (gstPct / 100);
                const lineTot = taxable + gstAmt;
                return { lineTot };
            }

            const today = new Date();
            $("#SystemDate").val(today.toLocaleDateString('en-GB'));

            //Get RQHeader By Code
            $.getJSON('/Purchase/GetRQHeaderByCodeVNK', { rqCode: rqCode })
                .done(function (h) {
                    if (!h) { alert("Header not found"); return; }
                    $("#RegisterQuotationCode").val(h.RegisterQuotationCode || "");
                    $("#RFQCode").val(h.RFQCode || "");
                    $("#VendorName").val(h.VendorName || "");
                    $("#VendorCode").val(h.VendorCode || "");
                    $("#CompanyName").val(h.CompanyName || "");
                    if (h.VendorDeliveryDateVK) {
                        const d = new Date(h.VendorDeliveryDateVK);
                        $("#VendorDeliveryDate").val(d.toLocaleDateString('en-GB'));
                    }
                    $("#ftShipping").text("₹ " + Number(h.ShippingCharges || 0).toFixed(2));
                });

           
            // Get RQItems By Code
            $.getJSON('/Purchase/GetRQItemsByCodeVNK', { rqCode: rqCode })
                .done(function (rows) {

                    // ✅ Destroy existing DataTable before changing table content
                    if ($.fn.DataTable.isDataTable('#grid')) {
                        $('#grid').DataTable().clear().destroy();
                    }

                    const $tb = $("#grid tbody").empty();
                    let subTotal = 0;

                    (rows || []).forEach(function (r, idx) {
                        const c = calcLine(r.Quantity, r.CostPerUnit, r.Discount, r.GST);
                        subTotal += c.lineTot;
                        $tb.append(`
                <tr>
                    <td class="text-center">${idx + 1}</td>
                    <td class="text-center">${r.ItemCode}</td>
                    <td>${r.ItemName || ""}</td>
                    <td class="text-center" title="${r.Description || ''}" data-bs-toggle="tooltip">${r.Description || ""}</td>
                    <td class="text-end">${Number(r.Quantity || 0)}</td>
                    <td class="text-center">${r.UOMName || ""}</td>
                    <td class="text-end">₹ ${Number(r.CostPerUnit || 0).toFixed(2)}</td>
                    <td class="text-end">${Number(r.Discount || 0).toFixed(2)}%</td>
                    <td class="text-end">${Number(r.GST || 0).toFixed(2)}%</td>
                    <td class="text-end">₹ ${c.lineTot.toFixed(2)}</td>
                </tr>
            `);
                    });

                    // ✅ Update totals
                    $("#ftSubTotal").text("₹ " + subTotal.toFixed(2));
                    const shipping = Number($("#ftShipping").text().replace("₹", "").trim() || 0);
                    $("#ftGrand").text("₹ " + (subTotal + shipping).toFixed(2));

                    // ✅ Reinitialize DataTable AFTER adding rows
                    $('#grid').DataTable({
                        paging: true,
                        searching: false,
                        info: true,
                        ordering: false,
                        lengthChange: false,
                        pageLength: 10,
                        language: {
                            info: "Showing _START_ to _END_ of _TOTAL_ entries",
                            infoEmpty: "No entries available",
                            lengthMenu: "Show _MENU_ entries",
                            paginate: { previous: "<", next: ">" }
                        },
                        dom: '<"d-flex justify-content-between align-items-center mb-2"l><"table-responsive"t><"d-flex justify-content-between align-items-center mt-2"ip>'
                    });

                    // Re-enable tooltips
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                });


            $("#btnPrint").on("click", function () {
                window.print();
            });
            })();





        //Modal Hide show
        $(document).on('hidden.bs.modal', '.modal', function () {
            if ($('.modal.show').length) {
                $('body').addClass('modal-open');
            }
        });

    </script>

</body>
</html>